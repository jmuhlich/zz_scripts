from rdkit import Chem, DataStructs
from rdkit.Chem import AllChem

# Database (e.g. Chembl)
database = (
    ('Temsirolimus', 'InChI=1S/C56H87NO16/c1-33-17-13-12-14-18-34(2)45(68-9)29-41-22-20-39(7)56(67,73-41)51(63)52(64)57-24-16-15-19-42(57)53(65)71-46(30-43(60)35(3)26-38(6)49(62)50(70-11)48(61)37(5)25-33)36(4)27-40-21-23-44(47(28-40)69-10)72-54(66)55(8,31-58)32-59/h12-14,17-18,26,33,35-37,39-42,44-47,49-50,58-59,62,67H,15-16,19-25,27-32H2,1-11H3'),
    ('Doxorubicin', 'InChI=1S/C27H29NO11/c1-10-22(31)13(28)6-17(38-10)39-15-8-27(36,16(30)9-29)7-12-19(15)26(35)21-20(24(12)33)23(32)11-4-3-5-14(37-2)18(11)25(21)34/h3-5,10,13,15,17,22,29,31,33,35-36H,6-9,28H2,1-2H3/t10-,13-,15-,17-,22+,27-/m0/s1'),
    ('(+)-JQ1', 'InChI=1S/C23H25ClN4O2S/c1-12-13(2)31-22-19(12)20(15-7-9-16(24)10-8-15)25-17(11-18(29)30-23(4,5)6)21-27-26-14(3)28(21)22/h7-10,17H,11H2,1-6H3/t17-/m0/s1'),
    ('Tozasertib', 'InChI=1S/C23H28N8OS/c1-15-13-20(29-28-15)25-19-14-21(31-11-9-30(2)10-12-31)27-23(26-19)33-18-7-5-17(6-8-18)24-22(32)16-3-4-16/h5-8,13-14,16H,3-4,9-12H2,1-2H3,(H,24,32)(H2,25,26,27,28,29)'),
    ('Selumetinib', 'InChI=1S/C17H15BrClFN4O3/c1-24-8-21-16-13(24)7-10(17(26)23-27-5-4-25)15(14(16)20)22-12-3-2-9(18)6-11(12)19/h2-3,6-8,22,25H,4-5H2,1H3,(H,23,26)'),
    ('Torin1', 'InChI=1S/C35H28F3N5O2/c1-2-32(44)42-15-13-41(14-16-42)31-11-9-26(19-28(31)35(36,37)38)43-33(45)12-8-24-20-40-30-10-7-22(18-27(30)34(24)43)25-17-23-5-3-4-6-29(23)39-21-25/h3-12,17-21H,2,13-16H2,1H3'),
    ('Erlotinib', 'InChI=1S/C22H23N3O4/c1-4-16-6-5-7-17(12-16)25-22-18-13-20(28-10-8-26-2)21(29-11-9-27-3)14-19(18)23-15-24-22/h1,5-7,12-15H,8-11H2,2-3H3,(H,23,24,25)'),
    ('Pazopanib', 'InChI=1S/C21H23N7O2S/c1-13-5-6-15(11-19(13)31(22,29)30)24-21-23-10-9-20(25-21)27(3)16-7-8-17-14(2)28(4)26-18(17)12-16/h5-12H,1-4H3,(H2,22,29,30)(H,23,24,25)'),
    ('LDN-193189', 'InChI=1S/C25H22N6/c1-2-4-24-22(3-1)21(9-10-27-24)23-16-29-31-17-19(15-28-25(23)31)18-5-7-20(8-6-18)30-13-11-26-12-14-30/h1-10,15-17,26H,11-14H2'),
    ('Buparlisib', 'InChI=1S/C18H21F3N6O2/c19-18(20,21)13-9-15(22)23-11-12(13)14-10-16(26-1-5-28-6-2-26)25-17(24-14)27-3-7-29-8-4-27/h9-11H,1-8H2,(H2,22,23)'),
    ('Foretinib', 'InChI=1S/C34H34F2N4O6/c1-43-30-20-25-27(21-31(30)45-16-2-13-40-14-17-44-18-15-40)37-12-9-28(25)46-29-8-7-24(19-26(29)36)39-33(42)34(10-11-34)32(41)38-23-5-3-22(35)4-6-23/h3-9,12,19-21H,2,10-11,13-18H2,1H3,(H,38,41)(H,39,42)'),
)

# Stuff to find in the database
queries = (
    ('Temsirolimus', 'InChI=1S/C56H87NO16/c1-33-17-13-12-14-18-34(2)45(68-9)29-41-22-20-39(7)56(67,73-41)51(63)52(64)57-24-16-15-19-42(57)53(65)71-46(30-43(60)35(3)26-38(6)49(62)50(70-11)48(61)37(5)25-33)36(4)27-40-21-23-44(47(28-40)69-10)72-54(66)55(8,31-58)32-59/h12-14,17-18,26,33,35-37,39-42,44-47,49-50,58-59,62,67H,15-16,19-25,27-32H2,1-11H3'),
    ('Sirolimus', 'InChI=1S/C51H79NO13/c1-30-16-12-11-13-17-31(2)42(61-8)28-38-21-19-36(7)51(60,65-38)48(57)49(58)52-23-15-14-18-39(52)50(59)64-43(33(4)26-37-20-22-40(53)44(27-37)62-9)29-41(54)32(3)25-35(6)46(56)47(63-10)45(55)34(5)24-30/h11-13,16-17,25,30,32-34,36-40,42-44,46-47,53,56,60H,14-15,18-24,26-29H2,1-10H3'),
    ('Epirubicin', 'InChI=1S/C27H29NO11/c1-10-22(31)13(28)6-17(38-10)39-15-8-27(36,16(30)9-29)7-12-19(15)26(35)21-20(24(12)33)23(32)11-4-3-5-14(37-2)18(11)25(21)34/h3-5,10,13,15,17,22,29,31,33,35-36H,6-9,28H2,1-2H3/t10-,13-,15-,17-,22-,27-/m0/s1'),
    ('(+)-JQ1', 'InChI=1S/C23H25ClN4O2S/c1-12-13(2)31-22-19(12)20(15-7-9-16(24)10-8-15)25-17(11-18(29)30-23(4,5)6)21-27-26-14(3)28(21)22/h7-10,17H,11H2,1-6H3/t17-/m0/s1'),
    ('(-)-JQ1', 'InChI=1S/C23H25ClN4O2S/c1-12-13(2)31-22-19(12)20(15-7-9-16(24)10-8-15)25-17(11-18(29)30-23(4,5)6)21-27-26-14(3)28(21)22/h7-10,17H,11H2,1-6H3/t17-/m1/s1'),
    ('Seliciclib', 'InChI=1S/C19H26N6O/c1-4-15(11-26)22-19-23-17(20-10-14-8-6-5-7-9-14)16-18(24-19)25(12-21-16)13(2)3/h5-9,12-13,15,26H,4,10-11H2,1-3H3,(H2,20,22,23,24)/t15-/m1/s1'),
    ('Lapatinib', 'InChI=1S/C29H26ClFN4O4S/c1-40(36,37)12-11-32-16-23-7-10-27(39-23)20-5-8-26-24(14-20)29(34-18-33-26)35-22-6-9-28(25(30)15-22)38-17-19-3-2-4-21(31)13-19/h2-10,13-15,18,32H,11-12,16-17H2,1H3,(H,33,34,35)'),
)

def make_fingerprint(mol):
    return AllChem.GetMorganFingerprintAsBitVect(mol, 2, nBits=1024)

fps_db = [make_fingerprint(Chem.MolFromInchi(rec[1])) for rec in database]
fps_q = [make_fingerprint(Chem.MolFromInchi(rec[1])) for rec in queries]

matches = []
for fp1 in fps_q:
    best_similarity = 0
    best_names = []
    for i, fp2 in enumerate(fps_db):
        similarity = DataStructs.FingerprintSimilarity(
            fp1, fp2, DataStructs.TanimotoSimilarity
        )
        if similarity > best_similarity:
            best_similarity = similarity
            best_names = [database[i][0]]
        elif similarity == best_similarity:
            best_names.append(database[i][0])
    matches.append((best_names, best_similarity))

print('%-20s %-30s %s' % ('Query', 'Matches', 'Similarity'))
print('%-20s %-30s %s' % ('-----', '-----', '----------'))
for query, match in zip(queries, matches):
    print('%-20s %-30s %f' % (query[0], ','.join(match[0]), match[1]))
